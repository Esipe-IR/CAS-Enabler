{% extends 'base.iframe.html.twig' %}

{% block body %}
    <button id="connect" class="btn btn-warning" style="background: #EB5B0C;">Connect with UPEM</button>
{% endblock %}

{% block javascripts %}
    <script>
        $(document).ready(function() {
            var $config = {
                uid: null
            };

            var $chan = Channel.build({
                window: window.parent,
                origin: "*",
                scope: "CAS.Scope"
            });

            $chan.bind("setUid", function(cli, uid) {
                $config.uid = uid;
                return 0;
            });

            $("#connect").click(function() {
                var url = "{{ path("service_token", {uid: "__"}) }}";
                url = url.replace("__", $config.uid);

                $.ajax({
                    url: url,
                    success: function(response) {
                        $chan.call({
                            method: "connect",
                            params: response,
                            success: function() {}
                        });
                    },
                    error: function(code) {
                        $chan.call({
                            method: "connect",
                            params: {status: false, code: code},
                            success: function() {}
                        });
                    }
                });
            });
        });
    </script>
{% endblock %}
